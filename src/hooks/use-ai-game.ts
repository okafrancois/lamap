"use client";

import { useEffect, useRef, useState } from "react";
import { useKoraEngine } from "./use-kora-engine";
import { AIPlayer } from "@/engine/ai-player";
import { gameEngine } from "@/engine/kora-game-engine";

export function useAIGame(difficulty: "easy" | "medium" | "hard" = "medium") {
  const koraEngine = useKoraEngine();
  const aiPlayer = useRef(new AIPlayer(difficulty));
  const [isAIThinking, setIsAIThinking] = useState(false);

  // Mettre Ã  jour la difficultÃ© de l'IA
  useEffect(() => {
    aiPlayer.current.setDifficulty(difficulty);
  }, [difficulty]);

  // GÃ©rer le tour de l'IA automatiquement
  useEffect(() => {
    const handleAITurn = () => {
      console.log("ðŸ¤– Check IA:", {
        phase: koraEngine.phase,
        currentTurn: koraEngine.currentTurn,
        isAIThinking,
      });

      // Ã‰viter les appels multiples simultanÃ©s
      if (isAIThinking) return;

      // VÃ©rifier si c'est le tour de l'IA et si la partie est en cours
      if (
        koraEngine.phase === "playing" &&
        koraEngine.currentTurn === "opponent"
      ) {
        console.log("ðŸ¤– IA va jouer !");
        setIsAIThinking(true);

        // DÃ©lai pour simuler la rÃ©flexion de l'IA
        const thinkingTime =
          difficulty === "easy" ? 500 : difficulty === "medium" ? 1000 : 1500;

        setTimeout(() => {
          const gameState = gameEngine.getState();
          const chosenCard = aiPlayer.current.chooseCard(gameState);

          if (chosenCard) {
            const success = koraEngine.playCard(chosenCard.id, "opponent");
            if (!success) {
              console.warn(
                "L'IA n'a pas pu jouer la carte choisie:",
                chosenCard,
              );
            }
          }

          setIsAIThinking(false);
        }, thinkingTime);
      }
    };

    // DÃ©lai pour Ã©viter les conflits avec les mises Ã  jour d'Ã©tat
    const timeoutId = setTimeout(handleAITurn, 100);

    return () => clearTimeout(timeoutId);
  }, [koraEngine.phase, koraEngine.currentTurn, isAIThinking, difficulty]);

  const startAIGame = () => {
    console.log("ðŸŽ® DÃ©marrage de la partie contre l'IA");
    setIsAIThinking(false);
    koraEngine.startGame();
    console.log("ðŸŽ® Phase aprÃ¨s dÃ©marrage:", koraEngine.phase);
  };

  const playCardAgainstAI = (cardId: string) => {
    console.log(
      "ðŸŽ¯ Joueur joue carte:",
      cardId,
      "currentTurn:",
      koraEngine.currentTurn,
    );
    if (koraEngine.currentTurn === "player" && !isAIThinking) {
      const success = koraEngine.playCard(cardId, "player");
      console.log(
        "ðŸŽ¯ Carte jouÃ©e avec succÃ¨s:",
        success,
        "nouveau tour:",
        koraEngine.currentTurn,
      );
      return success;
    }
    return false;
  };

  return {
    // Ã‰tat du jeu
    ...koraEngine,

    // Actions spÃ©cifiques Ã  l'IA
    startAIGame,
    playCardAgainstAI,

    // Ã‰tat de l'IA
    aiDifficulty: difficulty,
    isAIThinking,

    // MÃ©thodes utilitaires
    setAIDifficulty: (newDifficulty: "easy" | "medium" | "hard") => {
      aiPlayer.current.setDifficulty(newDifficulty);
    },
  };
}
